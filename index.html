<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>F√°brica de cr√©dito</title>
<style>
:root {
    --primary: #004AAD;
    --primary-light: #eaf1ff;
    --bg: #f8faff;
    --text: #1f1f1f;
    --radius: 14px;
    --success: #28a745;
    --warning: #FFC107;
    --error: #DC3545;
}
body { margin:0; font-family:'Segoe UI',sans-serif; background-color:var(--bg); display:flex; flex-direction:column; align-items:center;}
header{text-align:center;margin-top:40px;}
header h1{color:var(--primary); font-size:26px;margin-bottom:10px;}
header p{color:#666;font-size:15px;margin-top:0;}
form{background-color:white;width:90%;max-width:480px;border-radius:var(--radius);box-shadow:0 8px 20px rgba(0,0,0,0.08);padding:30px 40px;margin:30px 0;display:flex;flex-direction:column;gap:18px;animation:fadeIn 0.8s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(25px);}to{opacity:1;transform:translateY(0);}}
label{font-weight:600;color:var(--text);font-size:14px;margin-bottom:4px;}
input,select,textarea{width:100%;padding:12px 14px;border:1px solid #d0d8e4;border-radius:10px;font-size:15px;transition:all 0.3s ease;background-color:#fafcff;}
input:focus,select:focus,textarea:focus{border-color:var(--primary);background-color:white;box-shadow:0 0 0 2px var(--primary-light);outline:none;}
textarea{resize:vertical;min-height:60px;}
input[readonly]{background-color:#eef3ff;border-color:#cbd6f1;}
button{background-color:var(--primary);color:white;border:none;border-radius:10px;font-size:16px;padding:14px;font-weight:600;cursor:pointer;margin-top:10px;transition: background 0.3s ease;}
button:hover{background-color:#003A8C;}
.hidden{display:none;}
#customAlert{position:fixed;top:20px;right:20px;background-color:var(--success);color:white;padding:15px 20px;border-radius:var(--radius);box-shadow:0 4px 10px rgba(0,0,0,0.1);z-index:1000;animation:fadeIn 0.5s ease;font-size:14px;font-weight:600;}
</style>
</head>
<body>
<header>
<h1>üí∏F√ÅBRICA DE CR√âDITO</h1>
<p>Registro de negociaciones</p>
</header>

<div id="customAlert" class="hidden"></div>

<form id="formulario" action="https://script.google.com/macros/s/AKfycbxkgAwHgc6d3397RNVHgLdOoStyahN4NQ-p6686VwqCf9-bNIlFgHMvoLJajdY1QGrp/exec" method="POST">
<label>Etapa</label>
<select name="ETAPA" required>
<option value=""></option>
<option>PREVENTIVA</option>
<option>ADMINISTRATIVA</option>
<option>PREJUR√çDICA</option>
<option>JUR√çDICA</option>
</select>

<label>Documento Tercero</label>
<input type="text" id="documentoTercero" name="DOCUMENTO_TERCERO" maxlength="10" oninput="this.value=this.value.replace(/[^a-zA-Z0-9]/g,'').slice(0,10);">

<label>Documento Estudiante</label>
<input type="text" id="documentoEstudiante" name="DOCUMENTO_ESTUDIANTE" required maxlength="10" oninput="this.value=this.value.replace(/[^a-zA-Z0-9]/g,'').slice(0,10);">

<label>Documento Titular</label>
<input type="text" id="documentoTitular" name="DOCUMENTO_TITULAR" required maxlength="10" oninput="this.value=this.value.replace(/[^a-zA-Z0-9]/g,'').slice(0,10);">

<label>Contrato</label>
<input type="text" id="contrato" name="CONTRATO" required minlength="5" maxlength="16" oninput="this.value=this.value.replace(/[^a-zA-Z0-9\-]/g,'').slice(0,16);">

<label>Gestor Asignado</label>
<input type="text" id="gestorAsignado" name="GESTOR_ASIGNADO" required maxlength="10" oninput="this.value=this.value.replace(/[^a-zA-Z0-9]/g,'').slice(0,10);">

<label>Valor Contrato</label>
<input type="text" id="valorContrato" name="VALOR_CONTRATO" required>

<label>Total Pagos</label>
<input type="text" id="totalPagos" name="TOTAL_PAGOS" required>

<label>Total Pendiente</label>
<input type="text" id="totalPendiente" name="TOTAL_PENDIENTE" readonly>

<div id="tarifaContainer" class="hidden">
<label>Tarifa Pronto Pago o Converso</label>
<input type="text" id="tarifaProntoPago" name="TARIFA_PRONTO_PAGO_O_CONVERSO" oninput="calcularValores()">
</div>

<label>Negociaci√≥n</label>
<select id="negociacion" name="NEGOCIACION" required oninput="actualizarCamposCondicionales(); calcularValores();">
<option value=""></option>
<option>CL√ÅUSULA ESPECIAL</option>
<option>CL√ÅUSULA PENAL</option>
<option>CONVERSO</option>
<option>DESCUENTO</option>
<option>PRONTO PAGO</option>
<option>PAGO TOTAL</option>
</select>

<label>Financiera</label>
<select name="FINANCIERA" required oninput="calcularValores()">
<option value=""></option>
<option>ADDI</option>
<option>MERCADO PAGO</option>
<option>CESANT√çAS</option>
<option>BANCO DE BOGOT√Å</option>
<option>BANCOOMEVA</option>
<option>COMULTRASAN</option>
<option>FINCOMERCIO</option>
</select>

<div id="descuentoContainer" class="hidden">
<label>% Descuento 
<a id="linkDescuento" href="https://docs.google.com/spreadsheets/d/17f4zrszU17kA-E2VgBjGqd9qN3oKUCrDsB6YWy3qwJE/edit?usp=sharing" target="_blank" style="font-size:12px;margin-left:5px;text-decoration:underline;color:var(--primary);display:none;">Ver referencia</a>
</label>
<input type="number" id="porcentajeDescuento" name="PORCENTAJE_DESCUENTO" step="0.01" min="0" max="100" oninput="if(this.value>100)this.value=100;if(this.value<0)this.value=0; calcularValores();">
</div>

<div id="valorDescuentoContainer" class="hidden">
<label>Valor Descuento</label>
<input type="text" id="valorDescuento" name="VALOR_DESCUENTO" readonly>
</div>

<label>Valor a Pagar</label>
<input type="text" id="valorPagar" name="VALOR_A_PAGAR" readonly>

<label>Fecha de Pago</label>
<input type="date" name="FECHA_PAGO" required oninput="calcularValores()">

<div id="saldoFinalContainer" class="hidden">
<label>Saldo Final</label>
<input type="text" id="saldoFinal" name="SALDO_FINAL" readonly>
</div>

<label>Estado</label>
<select name="ESTADO" required oninput="calcularValores()">
<option value=""></option>
<option>APROBADO</option>
</select>

<label>Observaciones</label>
<textarea name="OBSERVACIONES"></textarea>

<button type="submit">Guardar</button>
</form>

<script>
const formulario = document.getElementById('formulario');
const alertBox = document.getElementById('customAlert');

function mostrarAlerta(mensaje, color){
    alertBox.textContent = mensaje;
    alertBox.style.backgroundColor = color;
    alertBox.classList.remove('hidden');
    setTimeout(()=> alertBox.classList.add('hidden'),3000);
}

function limpiarNumero(valor){ return parseFloat(valor.replace(/[^\d]/g,'')) || 0; }
function formatNumber(num){ return num.toLocaleString('es-CO',{minimumFractionDigits:0}); }

function actualizarCamposCondicionales(){
    const negociacion = document.getElementById('negociacion').value;
    const tarifaContainer = document.getElementById('tarifaContainer');
    const descuentoContainer = document.getElementById('descuentoContainer');
    const linkDescuento = document.getElementById('linkDescuento');
    tarifaContainer.classList.toggle('hidden', !(negociacion==='PRONTO PAGO'||negociacion==='CONVERSO'));
    descuentoContainer.classList.toggle('hidden', negociacion!=='DESCUENTO');
    linkDescuento.style.display = (negociacion==='DESCUENTO') ? 'inline' : 'none';
    calcularValores();
}

function calcularValores(){
    const valorContrato = limpiarNumero(document.getElementById('valorContrato').value||'0');
    const totalPagos = limpiarNumero(document.getElementById('totalPagos').value||'0');
    const tarifaProntoPago = limpiarNumero(document.getElementById('tarifaProntoPago').value||'0');
    const negociacion = document.getElementById('negociacion').value;
    const porcentajeDescuento = parseFloat(document.getElementById('porcentajeDescuento').value||'0');
    const valorDescuentoContainer = document.getElementById('valorDescuentoContainer');
    const saldoFinalContainer = document.getElementById('saldoFinalContainer');

    let totalPendiente = valorContrato - totalPagos; if(totalPendiente<0) totalPendiente=0;
    let valorAPagar = 0;
    switch(negociacion?.toUpperCase()){
        case 'CL√ÅUSULA ESPECIAL': valorAPagar=699999; break;
        case 'CL√ÅUSULA PENAL': valorAPagar=Math.floor(totalPendiente*0.25); break;
        case 'PAGO TOTAL': valorAPagar=totalPendiente; break;
        case 'PRONTO PAGO':
        case 'CONVERSO': valorAPagar=Math.max(0,tarifaProntoPago-totalPagos); break;
        case 'DESCUENTO': valorAPagar=Math.floor(totalPendiente-(totalPendiente*(porcentajeDescuento/100))); break;
        default: valorAPagar=0;
    }

    const valorDescuento = Math.max(0,totalPendiente-valorAPagar);
    let saldoFinal = totalPendiente - valorAPagar - valorDescuento; if(saldoFinal<0) saldoFinal=0;

    if(valorAPagar>0){ valorDescuentoContainer.classList.remove('hidden'); saldoFinalContainer.classList.remove('hidden'); }
    else{ valorDescuentoContainer.classList.add('hidden'); saldoFinalContainer.classList.add('hidden'); }

    document.getElementById('totalPendiente').value = formatNumber(totalPendiente);
    document.getElementById('valorPagar').value = formatNumber(valorAPagar);
    document.getElementById('valorDescuento').value = formatNumber(valorDescuento);
    document.getElementById('saldoFinal').value = formatNumber(saldoFinal);
}

// Evento submit optimizado
formulario.addEventListener('submit', function(e){
    e.preventDefault();
    const docT = document.getElementById('documentoTercero');
    const obs = formulario.querySelector('textarea[name="OBSERVACIONES"]');
    if(!docT.value) docT.value='0';
    if(!obs.value) obs.value='0';
    
    formulario.reset(); // Limpieza inmediata
    mostrarAlerta('üü° Guardando registro‚Ä¶','var(--warning)');

    fetch(this.action,{method:'POST',body:new FormData(this),mode:'no-cors'})
    .then(()=> mostrarAlerta('‚úÖ Registro enviado exitosamente','var(--success)'))
    .catch(()=> mostrarAlerta('‚ùå Error al enviar los datos','var(--error)'));
});

// Formato con miles y m√°ximo 8 d√≠gitos
['valorContrato','totalPagos'].forEach(id=>{
    const input = document.getElementById(id);
    function formatear(){
        let valor = this.value.replace(/[^\d]/g,'').slice(0,8);
        this.value = valor ? parseInt(valor).toLocaleString('es-CO') : '';
        calcularValores();
    }
    input.addEventListener('input', formatear);
    input.addEventListener('paste', function(e){
        e.preventDefault();
        let paste = (e.clipboardData||window.clipboardData).getData('text').replace(/[^\d]/g,'').slice(0,8);
        this.value = paste ? parseInt(paste).toLocaleString('es-CO') : '';
        calcularValores();
    });
});
</script>
</body>
</html>
