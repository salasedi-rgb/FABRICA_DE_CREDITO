<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞F√ÅBRICA DE CR√âDITO</title>
    <style>
        /* ...tu CSS original permanece igual... */
    </style>
</head>
<body>
    <header>
        <h1>üí∏F√ÅBRICA DE CR√âDITO</h1>
        <p>Registro de negociaciones</p>
    </header>

    <form id="formulario">
        <!-- ...todos los campos originales del formulario... -->
        <button type="submit">Guardar</button>
        <p id="mensaje"></p>
    </form>

    <script>
        const webAppUrl = "https://script.google.com/macros/s/AKfycbwapPHH5EDpXkOw88IvJqXgmFgNw42eKRJABB5cuEVYzPNjipF-gWssAOTiXvGoI9_T/exec";

        function limpiarNumero(valor) {
            return parseFloat(valor.replace(/[^\d]/g, '')) || 0;
        }

        function formatNumber(num) {
            return num.toLocaleString('es-CO', {minimumFractionDigits: 0});
        }

        function actualizarCamposCondicionales() {
            const negociacion = document.getElementById('negociacion').value;
            const tarifaContainer = document.getElementById('tarifaContainer');
            const descuentoContainer = document.getElementById('descuentoContainer');

            tarifaContainer.classList.toggle('hidden', !(negociacion === 'PRONTO PAGO' || negociacion === 'CONVERSO'));
            descuentoContainer.classList.toggle('hidden', negociacion !== 'DESCUENTO');
            calcularValores();
        }

        function calcularValores() {
            const valorContrato = limpiarNumero(document.getElementById('valorContrato').value || '0');
            const totalPagos = limpiarNumero(document.getElementById('totalPagos').value || '0');
            const tarifaProntoPago = limpiarNumero(document.getElementById('tarifaProntoPago').value || '0');
            const negociacion = document.getElementById('negociacion').value;
            const porcentajeDescuento = parseFloat(document.getElementById('porcentajeDescuento').value || '0');
            const valorDescuentoContainer = document.getElementById('valorDescuentoContainer');
            const saldoFinalContainer = document.getElementById('saldoFinalContainer');

            let totalPendiente = valorContrato - totalPagos;
            if (totalPendiente < 0) totalPendiente = 0;

            let valorAPagar = 0;
            switch (negociacion?.toUpperCase()) {
                case 'CL√ÅUSULA ESPECIAL':
                    valorAPagar = 699999;
                    break;
                case 'CL√ÅUSULA PENAL':
                    valorAPagar = Math.floor(totalPendiente * 0.25);
                    break;
                case 'PAGO TOTAL':
                    valorAPagar = totalPendiente;
                    break;
                case 'PRONTO PAGO':
                case 'CONVERSO':
                    valorAPagar = Math.max(0, tarifaProntoPago - totalPagos);
                    break;
                case 'DESCUENTO':
                    valorAPagar = Math.floor(totalPendiente - (totalPendiente * (porcentajeDescuento / 100)));
                    break;
                default:
                    valorAPagar = 0;
            }

            const valorDescuento = Math.max(0, totalPendiente - valorAPagar);
            let saldoFinal = totalPendiente - valorAPagar - valorDescuento;
            if (saldoFinal < 0) saldoFinal = 0;

            if (valorAPagar > 0) {
                valorDescuentoContainer.classList.remove('hidden');
                saldoFinalContainer.classList.remove('hidden');
            } else {
                valorDescuentoContainer.classList.add('hidden');
                saldoFinalContainer.classList.add('hidden');
            }

            document.getElementById('totalPendiente').value = formatNumber(totalPendiente);
            document.getElementById('valorPagar').value = formatNumber(valorAPagar);
            document.getElementById('valorDescuento').value = formatNumber(valorDescuento);
            document.getElementById('saldoFinal').value = formatNumber(saldoFinal);
        }

        document.getElementById("formulario").addEventListener("submit", async function(e) {
            e.preventDefault();
            const mensaje = document.getElementById("mensaje");
            mensaje.textContent = "‚è≥ Enviando datos...";
            mensaje.style.color = "#444";

            const formElements = this.elements;
            const formData = new URLSearchParams();
            for (let i = 0; i < formElements.length; i++) {
                const el = formElements[i];
                if (el.name) {
                    formData.append(el.name, el.value);
                }
            }

            try {
                const response = await fetch(webAppUrl, {
                    method: "POST",
                    body: formData
                });

                const result = await response.json();

                if (result.result === "success") {
                    mensaje.textContent = "‚úÖ Datos guardados correctamente.";
                    mensaje.style.color = "green";
                    this.reset();
                } else {
                    mensaje.textContent = "‚ö†Ô∏è Error del servidor: " + result.message;
                    mensaje.style.color = "red";
                }
            } catch (error) {
                console.error("Error al enviar:", error);
                mensaje.textContent = "‚ùå Error al enviar los datos. Intenta nuevamente.";
                mensaje.style.color = "red";
            }
        });
    </script>
</body>
</html>

